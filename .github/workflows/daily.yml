name: Daily MRI Update

on:
  workflow_dispatch:
  schedule:
    - cron: "17 1 * * *"

concurrency:
  group: daily-mri-update-main
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  daily:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm install

      - name: Check API key
        run: |
          if [ -z "${ALPHA_VANTAGE_KEY}" ]; then
            echo "ALPHA_VANTAGE_KEY missing"
            exit 1
          fi
        env:
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}

      - name: Fetch Alpha Vantage data
        run: node scripts/fetch_market_data.js
        env:
          ALPHA_VANTAGE_KEY: ${{ secrets.ALPHA_VANTAGE_KEY }}

      - name: Generate daily data
        run: |
          set -euo pipefail
          mkdir -p tools/cache
          node tools/generate_seo_matrix.js --count 40
          node tools/generate_daily.js | tee tools/cache/daily_run.log

      - name: Inspect latest.json outputs
        run: |
          set -euo pipefail
          ls -lah public || true
          ls -lah public/data || true
          echo "---- ROOT latest.json ----" && test -f latest.json && head -n 80 latest.json || echo "MISSING: latest.json"
          echo "---- PUBLIC latest.json ----" && test -f public/latest.json && head -n 80 public/latest.json || echo "MISSING: public/latest.json"
          echo "---- PUBLIC/DATA latest.json ----" && test -f public/data/latest.json && head -n 120 public/data/latest.json || echo "MISSING: public/data/latest.json"

          node - <<'NODE'
          const fs = require('fs');
          const path = 'public/data/latest.json';
          if (!fs.existsSync(path)) {
            console.error('MISSING: public/data/latest.json');
            process.exit(1);
          }
          const data = JSON.parse(fs.readFileSync(path, 'utf-8'));
          const requiredKeys = ['inputsTable','components','drivers','outlook','responsePlan','bondsRange','cashRange'];
          const missing = requiredKeys.filter(k => !(k in data));
          if (missing.length) {
            console.error('Missing keys:', missing.join(', '));
            process.exit(1);
          }
          const inputs = Array.isArray(data.inputsTable) ? data.inputsTable.map(x => x.asset) : [];
          const expected = ['SPY','QQQ','TLT','GLD'];
          const missingAssets = expected.filter(a => !inputs.includes(a));
          if (missingAssets.length) {
            console.error('inputsTable missing assets:', missingAssets.join(', '));
            process.exit(1);
          }
          const allowed = ['Above MA200','Below MA200','Insufficient data'];
          const badMa200 = (data.inputsTable || []).filter(r => !allowed.includes(r.ma200Pos));
          if (badMa200.length) {
            console.error('Invalid ma200Pos values:', badMa200.map(r => `${r.asset}:${r.ma200Pos}`).join(', '));
            process.exit(1);
          }
          console.log('latest.json schema check passed');
          NODE

      - name: Smoke check outputs
        run: |
          set -euo pipefail
          {
            echo "== Output Checks ==";
            test -f public/data/risk_index.json && echo "OK: public/data/risk_index.json" || (echo "MISSING: public/data/risk_index.json" && exit 1);
            test -f public/data/daily.json && echo "OK: public/data/daily.json" || (echo "MISSING: public/data/daily.json" && exit 1);
            test -f public/data/risk_index_history.json && echo "OK: public/data/risk_index_history.json" || (echo "MISSING: public/data/risk_index_history.json" && exit 1);
            test -f public/data/share_text.json && echo "OK: public/data/share_text.json" || (echo "MISSING: public/data/share_text.json" && exit 1);
            test -f public/og/mri-latest.png && echo "OK: public/og/mri-latest.png" || (echo "MISSING: public/og/mri-latest.png" && exit 1);
            test -f sitemap.xml && echo "OK: sitemap.xml" || (echo "MISSING: sitemap.xml" && exit 1);
          } | tee tools/cache/smoke.txt

      - name: Write Actions Summary
        run: |
          set -euo pipefail
          gen_date=$(node -e "try{const d=require('./public/data/daily.json');console.log(d.date||'');}catch(e){console.log('');}")
          daily_json_count=$(ls public/daily/*.json 2>/dev/null | wc -l | tr -d ' ')
          daily_html_count=$(ls public/daily/*.html 2>/dev/null | wc -l | tr -d ' ')
          {
            echo "## Daily MRI Update Summary";
            echo "";
            echo "- Date: ${gen_date:-unknown}";
            echo "- Daily JSON count: ${daily_json_count:-0}";
            echo "- Daily HTML count: ${daily_html_count:-0}";
            echo "";
            echo "### Key Outputs";
            echo "- public/data/risk_index.json";
            echo "- public/data/daily.json";
            echo "- public/data/risk_index_history.json";
            echo "- public/data/share_text.json";
            echo "- public/og/mri-latest.png";
            echo "- sitemap.xml";
            echo "";
            echo "### Smoke Check";
            cat tools/cache/smoke.txt || true;
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Commit & push if changed
        run: |
          git config user.name "finlogichub-bot"
          git config user.email "bot@finlogichub5.com"
          git add public sitemap.xml tools/cache/prices.json
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "Daily: auto update"
          git pull --rebase origin main
          git push origin main

      - name: Ping sitemap (Google disabled)
        run: |
          echo "Google sitemap ping deprecated â€” skipping."
          exit 0

      - name: Upload debug artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: daily-mri-failure-${{ github.run_id }}
          path: |
            tools/cache/daily_run.log
            tools/cache/smoke.txt
            public/data/daily.json
            public/data/risk_index.json
            public/data/risk_index_history.json
            public/data/share_text.json
